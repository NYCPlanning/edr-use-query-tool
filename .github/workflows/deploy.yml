name: Deploy Query app to GitHub Pages
# This workflow builds and deploys a marimo notebook to GitHub Pages
# It runs automatically when changes are pushed to the main branch or can be triggered manually

# Defines when the workflow will run
on:
  push:
    branches: ['main']  # Trigger on pushes to main branch
  workflow_dispatch:    # Allow manual triggering from the GitHub UI

env:
  UV_SYSTEM_PYTHON: 1   # Use system Python with uv package manager

jobs:
  build:
      runs-on: ubuntu-latest

      steps:
          # Check out the repository code
          - uses: actions/checkout@v4

          # Install uv package manager for faster Python package installation
          - name: 🚀 Install uv
            uses: astral-sh/setup-uv@v6

          - name: 📄 Export notebook
            run: |
                uvx --verbose marimo export html-wasm --sandbox --mode run query.py -o _site_directory

          - name: 📄 Copy data files
            run: |
                mkdir -p _site_directory/output/for_query_tool/
                mv output/for_query_tool/* _site_directory/output/for_query_tool/
                tree _site_directory  # Display all exported files

          - name: 📄 Display all exported files
            run: |
                tree _site_directory

          - name: 📦 Upload Pages Artifact
            uses: actions/upload-pages-artifact@v3
            with:
                path: _site_directory

  deploy:
      needs: build
      runs-on: ubuntu-latest
      environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}

      permissions:
          pages: write
          id-token: write

      steps:
          - name: 🌐 Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4
            with:
                artifact_name: github-pages
